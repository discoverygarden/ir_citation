<?php
/**
 * @file
 *   This is the main module file for the ir_citation module
 * @author
 *   William Panting
 * @todo
 *   put in access permissions
 */

/**
 * The menu entries for this module.
 * @return $menu_entries
 *   An arrray of the items to be added to the drupal menu
 */
function ir_citation_menu() {
  $menu_entries= array();

  $menu_entries['institutional_repository']=array(
    'title' => 'Institutional Repository',
    'description' => 'Institutional Repository',
    'page callback' => 'ir_citation_cite',
    'access arguments' => array(),
    'type' => MENU_NORMAL_ITEM
  );
  
  return $menu_entries;
}

/**
 * This function will be the test be for citation generation.
 * It will generate the web page with citations.
 * @todo
 *   replace these add_js calls with custom wrapper functions
 */
function ir_citation_cite() {
  //init
  module_load_include('inc', 'ir_citation', 'ir_citation');
  $output='';
  
  drupal_add_js(drupal_get_path('module', 'ir_citation') . '/citeproc-js/demo/loadabbrevs.js');
  load_citeproc_javascript();
  drupal_add_js(drupal_get_path('module', 'ir_citation') . '/citeproc-js/demo/loadlocale.js');
  drupal_add_js(drupal_get_path('module', 'ir_citation') . '/citeproc-js/demo/loadsys.js');
  drupal_add_js(drupal_get_path('module', 'ir_citation') . '/citeproc-js/demo/loadcsl.js');
  //redo of citeproc's demo with mods->json conversion
  drupal_add_js(drupal_get_path('module', 'ir_citation') . '/demo/loadcites_js.php');
  drupal_add_js(drupal_get_path('module', 'ir_citation') . '/citeproc-js/demo/runcites.js');
  
  $output=$output . ir_citation_get_demo_html();
  return $output;
}

/**
 *removed for easy reading 
 */
function ir_citation_get_demo_html() {
  return '
	<h1>CSL Bibliography Samples</h1>

	<p>When viewed in Firefox, Safari, Google Chrome or Internet Explorer,
       this page (if you have enabled Javascript) will display a set of example bibliographies,
       illustrating some of the capabilities of
       the <span style="font-family: courier,
       monospace">citeproc-js</span> citation formatter, an
       implementation of the CSL 1.0 citation style language specification.  
	  For further information on CSL, see
       the <a href="http://citationstyles.org/">CSL website</a>.  For more
       details on the processor, see the
       <a href="http://gsl-nagoya-u.net/http/pub/citeproc-doc.html">processor manual</a>.
    </p>

    <p>A few comments on the bibliography listings below:</p>
    <ul>
       <li>
         These are generated from a single set
         of <a href="sampledata.html">database entries</a> supplied to
         the processor as a JSON object; the formatting you see is
         entirely controlled by style code fed to the CSL processor
         inside your browser.
       </li>
       <li>
         Most of the delay in loading the page is due to the loading
         of citation data and the instantiation of the processor
         for several separate styles.  These operations are performed
         once per cite and per style respectively; when deployed in
         a word processor or other editing environment, the rendering
         operations themselves should be reasonably fast.
       </li>
       <li>
         The cites in the running text below are a generated by
         a proof-of-concept Bluebook style.  The style is written
         in standard CSL 1.0.  Citation collapsing for parallel
         cites is done by analyzing content on the fly during
         rendering; no exceptional hints in the input data
         are required.
       </li>
       <li>
         As a techie gloss, the XML parsing engine differs according
         to the browser with which the page is called.  When viewed in
         Internet Explorer, Safari or Google Chrome, the CSL style
         code is read using the DOM.  For server-side use and in the
         Firefox browser, the processor uses the E4X parsing engine
         instead, which is available natively in the Rhino,
         Spidermonkey and Tracemonkey javascript implementations.)
        </li>
    </ul>

    <p>If parsing fails and you do not see bibliography listings below,
       please send mail to 
       <a href="mailto:biercenator@gmail.com">biercenator@gmail.com</a>, so
       we can adjust things to work with your browser.
    </p>

    <div class="heading">
       Chicago Author-Date (names sorted alphabetically, titles translated, no abbreviations, ambiguous name)
    </div>
    <p>
       Teren aldëon etelotya epë ma, murmë leuca rempa nu loc, nar
       raxë estel naitya oa. <span id="cad1"
       name="citation_cad">[cite]</span> Nu mir anca costa, arca rondë
       liéva ëa huo. <span id="cad2" name="citation_cad">[cite]</span>
       Aiwë pelentul tol sú. <span id="cad3"
       name="citation_cad">[cite]</span> Ëa harë línë tenna mel, eques
       talta ataqua qua sú. <span id="cad4"
       name="citation_cad">[cite]</span> Úvë ataqua simpina caimassë
       us, sir ronyo haloitë tareldar et, né manë mitta liquis
       eru. <span id="cad5" name="citation_cad">[cite]</span> Oi táp
       laicë nainanyéna leryalehtya, sindar nostalë at
       axa. <span id="cad6" name="citation_cad">[cite]</span> Wen
       namna sairon tellaurë er, hahta pendë quesset lia us, ré apa
       línë cotumo métima. <span id="cad7"
       name="citation_cad">[cite]</span>
    </p>
    <h2>References</h2>
	<div class="hangindent" id="chicago_author_date"><!--

        NOTE: The "hangindent" class is a shortcut hack used
        to display this specific page, which uses a static
        set of known styles.  Where styles can be dynamically
        assigned, the webserver or application should define
        a set of appropriate style classes, and provide them
        to the target rendering engine along with the processor
        output.  For guidance, see the relevant section of the
        processor manual:

          http://gsl-nagoya-u.net/http/pub/citeproc-doc.html#return-value

        -->
[Page generation failure.  The bibliography processor requires a browser with Javascript enabled.]</div>

    <div class="heading pagebreak">
       Bluebook + Chicago Fullnote Bibliography
    </div>
    <p>
      Bei un gewëss Hämmelsbrot d\'Margréitchen, gét Noper blëtzen
      Dauschen am.<sup>(1)</sup> Op dan engem Blieder Feierwon, un der
      ston zielen duerch.<sup>(2)</sup> Hin wielen heemlech mä, hu ech
      éiweg klinzecht.<sup>(3)</sup> Ass an Himmel rëschten, wee
      d\'wäiss bessert Freiesch dé, hirem d\'Leit Blieder eng
      an.<sup>(4)</sup> Si aus iwer Mamm, geet schlon op get, de Engel
      rifft gudden net.<sup>(5)</sup>
    </p>
    <p>
      Aus um fest spilt gefällt, hun zënne rëscht ké.<sup>(6)</sup> Mä
      Räis sech gemaacht déi, dé och Welt Hären, ech dénen geplot
      d\'Gaassen et.<sup>(7)</sup> Hier beschte verstoppen da ech, vill
      heemlech net um.<sup>(8)</sup> Esou Scholl schléit un fir. Wat
      ma\'n kille d\'Hiezer wa, frou Mecht Schiet am fir.<sup>(9)</sup>
      Mä rëm keng Engel bleiwe,<sup>(10)</sup> gëtt Stret geplot dé dem, déi zënne
      gudden löschteg op.<sup>(11)</sup>
    </p>
    <div style="width:5em">
       <hr />
    </div>
    <div class="footnote">
      <sup>(1)</sup> <span class="fntext" id="citation1" name="citation">[book (Census) with pinpoint]</span>
    </div>
    <div class="footnote">
      <sup>(2)</sup> <span class="fntext" id="citation2" name="citation">[book (Census) general ref] [std court decision, general ref][book (Census) pinpoint ref]
</span>
    </div>
    <div class="footnote">
      <sup>(3)</sup> <span class="fntext" id="citation3" name="citation">[code] [statute, session laws] [regulation]</span>
    </div>
    <div class="footnote">
      <sup>(4)</sup> <span class="fntext" id="citation4" name="citation">[article, general ref]</span>
    </div>
    <div class="footnote">
      <sup>(5)</sup> <span class="fntext" id="citation5" name="citation">[article, pinpoint] [code] [book D\'Arcus pinpoint] [book D\'Arcus general ref]</span>
    </div>
    <div class="footnote">
      <sup>(6)</sup> <span class="fntext" id="citation6" name="citation">[regulation]</span>
    </div>
    <div class="footnote">
      <sup>(7)</sup> <span class="fntext" id="citation7" name="citation">[court decision (public domain cite)]</span>
    </div>
    <div class="footnote">
      <sup>(8)</sup> <span class="fntext" id="citation8" name="citation">[court decision (UK) year as volume]</span>
    </div>
    <div class="footnote">
      <sup>(9)</sup> <span class="fntext" id="citation9" name="citation">[court decision (UK) with issue number]</span>
    </div>
    <div class="footnote">
      <sup>(10)</sup> <span class="fntext" id="citation10" name="citation">[zelle] [zelle (again)]</span>
    </div>
    <div class="footnote">
      <sup>(11)</sup> <span class="fntext" id="citation11" name="citation">[code again] [regulation]</span>
    </div>
    <h2>Bibliography</h2>
	<h3>Legal Resources</h3>
	<div class="hangindent" id="bluebook_demo_legal_stuff"><!-- See NOTE above --></div>
	<h3>Books</h3>
	<div class="hangindent" id="bluebook_demo_books"><!-- See NOTE above --></div>
	<h3>Articles</h3>
	<div class="hangindent" id="bluebook_demo_articles"><!-- See NOTE above --></div>
	
    <div class="heading pagebreak">
       Per-author publication listing
    </div>
    <div class="dateindent"><!-- See NOTE above -->
  	  <div id="chicago_author_date_listing"></div>
	</div>


    <div class="heading pagebreak">
       IEEE style ("slightly weird" abbreviations)
    </div>
	<div id="ieee"></div>
	
    <div class="heading pagebreak">
       Chicago Fullnote Bibliography (quotes inside punctuation, "default" abbreviations)
    </div>
	<div id="chicago_fullnote_bibliography2">[Placeholder]</div>
  ';
}

/**
 * drupal hook to show help
 * @param $path 
 *   The path that the help is being accessed from.
 * @return $help
 *   The help string that will be returned to the user.
 */
function ir_citation_help($path, $arg) {
  $help='';//default
  
  switch ($path) {
    case 'admin/modules#description' :
    $help= t('A generic citation helper module.');
  }
  
  return $help;
}