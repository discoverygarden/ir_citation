<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>README.txt</title>
<style type="text/css">

body { 
    width: 750px; 
    margin: auto; 
    position: center; 
    font-family: 'Lucida Sans', Verdana, sans-serif; 
    font-size: 10.5pt; 
    color: #434343;
    line-height: 135%; !important
}

.xml { padding: 1em; border: silver 1px solid; background: #EAFABC; }
.relaxngcompact { padding: 1em; border: silver 1px solid; background: #F6F9ED; }

.clothesline {
  position: relative;
}

.double-border {
  border: 5px double black;
}

h4 a {
  padding: 4px;
  border: 1px solid black;
}

/* .js { padding: 1em; border: silver 1px solid; background: #FFF68F; } */
.js { padding: 1em; border: silver 1px solid; background: #EAFABC; }
.text { padding: 1em; border: silver 1px solid; background: #FFcccc; }

dl { background: #B7FCE1; padding:1em; border: silver 1px solid;}
dt { font-weight: bold; margin-top: 0.5em; }

.info-version { text-align: center; font-size: 130%; font-weight: bold; }
.info-date { text-align: center; font-size: 110%; font-weight: bold; }
.title { text-align: center; margin: 4em 4em 1em 4em; }
.subtitle { text-align: center; margin: 1em 4em 4em 4em; }
.topic-title { font-weight: bold; font-size: 130%; }
.contents { margin-bottom: 1em; }
.center { text-align: center }



.contributors { margin-left: 250px; margin-top: 2em; margin-bottom: 2em; }
dl.contributors { background: white; border: none; }
.contributors dt { margin: 1em; }

span.sc {
  font-variant: small-caps;
  color: black;
}

tt.literal .pre {
  font-family: monospace;
  color: #232323;
  background: #d9d9d9;
  padding: 0px 2px 0px 2px;
}

a { 
    border-bottom: dotted 1px #999; 
    text-decoration: none;
}

blockquote {
    background: #B7FCE1; 
    margin-left: 3em;
    padding:1em; 
    border: silver 1px solid;
}

blockquote.inline-wrapper {
    background: white;
    margin: 0px;
    padding: 0px;
    border: 1px none black;
    text-align: center;
}

blockquote.inline-wrapper div {
    display: inline;
}

blockquote.inline-wrapper p {
    vertical-align: top;
    display: inline;
}

.superscript {
  margin-bottom: 1em;
}

a.toc-backref tt.literal .pre {
    background: white;
}


a:link { color: #636363; font-weight: bold;}
a:visited { color: #636363; font-weight: bold; }
a:active { color: #636363; font-weight: bold; }
a:hover { color: #a30826; font-weight: bold; }

a tt.literal .pre:link { color: #131313; }
a tt.literal .pre:visited { color: #131313; }
a tt.literal .pre:active { color: #131313; }
a tt.literal .pre:hover { color: #a30826; }

.contents a:link { color: #434343; font-weight: normal; }
.contents a:visited { color: #434343; font-weight: normal; }
.contents a:active { color: #434343; font-weight: normal; }
.contents a:hover { color: #a30826; }

a.toc-backref:link { color: black; } 
a.toc-backref:visited { color: black; } 
a.toc-backref:active { color: black; } 
a.toc-backref:hover { color: #a30826; }

blockquote.clothesline {
  position: relative;
  padding: 0px;
  margin: 0px;
  border: 0px none;
}

div.admonition {
  clear: both;
  border: 3px solid #c0c0c0;
  float: right;
  width: 37%;
  padding: 0px 5px 0px 5px;
  background: white;
  margin: -0.5em -0.5em 1em 5px;
}

blockquote.clothesline div.admonition {
  float: none;
  position: absolute;
  top: 0em;
  right: 0em;
}

div.admonition p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

div.admonition-important .admonition-title:before {
  content: url("important.png");
  padding-right: 5px;
}

div.admonition-hint .admonition-title:before {
  content: url("ktip.png");
  padding-right: 5px;
}

div.admonition p.admonition-title {
  font-weight: bold;
  font-size: 150%;
  border-bottom: 1px solid black;
  margin-top: 0px;
  margin-bottom: 0px;
  padding-top: 3px;
  padding-bottom: 3px;
}

table.footnote {
  background: #ffffdd;
  padding: 5px 0px 5px 0px;
  border: 1px solid #cccccc;
  margin: 0.3em 0px 0.3em 0px;
}

table.first {
  margin: 2.3em 0px 0.3em 0px;
}

table.hello { margin-left: 3em; }
table.hello td { padding: 3px; }
table.hello th { padding: 3px; background: #dddddd; }

table.footnote td.label {
  white-space: nowrap;
  padding-right: 0.3em;
}

a.fn-backref:before {
  content: url("2uparrow.png");
  padding-right: 2px;
}

a.footnote-reference {
  background: #ffffdd;
  padding: 5px 2px 0px 2px;
  white-space: nowrap;
}

a.footnote-reference:before {
  content: url("2downarrow.png");
  padding-right: 2px;
}

a.fn-backref {
  vertical-align: top;
}

/* .nx { color: red; font-weight: bold } */ /* Function name */

.c { color: #408080; font-style: italic } /* Comment */
.err { border: 1px solid #FF0000 } /* Error */

.k { color: #007020; font-weight: bold } /* Keyword  [DONE] */
.o { color: #666666 } /* Operator */
.cm { color: #408080; font-style: italic } /* Comment.Multiline */
.cp { color: #BC7A00 } /* Comment.Preproc */
.c1 { color: #408080; font-style: italic } /* Comment.Single */
.cs { color: #408080; font-style: italic } /* Comment.Special */
.gd { color: #A00000 } /* Generic.Deleted */
.ge { font-style: italic } /* Generic.Emph */
.gr { color: #FF0000 } /* Generic.Error */
.gh { color: #000080; font-weight: bold } /* Generic.Heading */
.gi { color: #00A000 } /* Generic.Inserted */
.go { color: #808080 } /* Generic.Output */
.gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.gs { font-weight: bold } /* Generic.Strong */
.gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.gt { color: #0040D0 } /* Generic.Traceback */
.kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.kp { color: #008000 } /* Keyword.Pseudo */
.kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.kt { color: #B00040 } /* Keyword.Type */
.m { color: #666666 } /* Literal.Number */
.s { color: #BA2121 } /* Literal.String */
.na { color: #7D9029 } /* Name.Attribute */
.nb { color: #008000 } /* Name.Builtin */
.nc { color: #0000FF; font-weight: bold } /* Name.Class */
.no { color: #880000 } /* Name.Constant */
.nd { color: #AA22FF } /* Name.Decorator */
.ni { color: #999999; font-weight: bold } /* Name.Entity */
.ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.nf { color: #0000FF } /* Name.Function */
.nl { color: #A0A000 } /* Name.Label */
.nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.nt { color: #008000; font-weight: bold } /* Name.Tag */
.nv { color: #19177C } /* Name.Variable */
.ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.w { color: #bbbbbb } /* Text.Whitespace */
.mf { color: #666666 } /* Literal.Number.Float */
.mh { color: #666666 } /* Literal.Number.Hex */
.mi { color: #666666 } /* Literal.Number.Integer */
.mo { color: #666666 } /* Literal.Number.Oct */
.sb { color: #BA2121 } /* Literal.String.Backtick */
.sc { color: #BA2121 } /* Literal.String.Char */
.sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.s2 { color: #BA2121 } /* Literal.String.Double */
.se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.sh { color: #BA2121 } /* Literal.String.Heredoc */
.si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.sx { color: #008000 } /* Literal.String.Other */
.sr { color: #BB6688 } /* Literal.String.Regex */
.s1 { color: #BA2121 } /* Literal.String.Single */
.ss { color: #19177C } /* Literal.String.Symbol */
.bp { color: #008000 } /* Name.Builtin.Pseudo */
.vc { color: #19177C } /* Name.Variable.Class */
.vg { color: #19177C } /* Name.Variable.Global */
.vi { color: #19177C } /* Name.Variable.Instance */
.il { color: #666666 } /* Literal.Number.Integer.Long */

table.codeblock, tr.codeblock, td.linenos, td.codeblock, table.codeblock pre { 
	margin: 0; 
	padding: 0; 
	border: 0; 
	vertical-align: baseline; 
	border: none; 
}

td.linenos { 
	border-right: 1px solid #AAAAAA; 
	text-align: right; 
	color: #AAAAAA; 
	padding-right: 5px; 
	padding-left: 5px; 
}

.codeblock { font-size: 110%; }

td.codeblock { padding-left: 5px; }
pre.codeblock { }
pre.codeblock span.Normal { }

pre.codeblock span.DataType { color: #902000; }
pre.codeblock span.DecVal { color: #40a070; }
pre.codeblock span.BaseN { color: #40a070; }
pre.codeblock span.Float { color: #40a070; }
pre.codeblock span.Char { color: #4070a0; }
pre.codeblock span.String { color: #4070a0; }
pre.codeblock span.Comment { color: #60a0b0; font-style: italic; }
pre.codeblock span.Others { color: #007020; }
pre.codeblock span.Alert { color: red; font-weight: bold; }
pre.codeblock span.Function { color: #06287e; }
pre.codeblock span.RegionMarker { }
pre.codeblock span.Error { color: red; font-weight: bold; }

</style>
</head>
<body>
<div class="document" id="readme-txt">
<h1 class="title">README.txt</h1>
<h2 class="subtitle" id="citeproc-js"><tt class="docutils literal"><span class="pre">citeproc-js</span></tt></h2>

<div class="center container">
<p>Frank Bennett</p>
<p><em>Graduate School of Law, Nagoya University</em></p>
<p>2009.08.20</p>
</div>
<hr class="docutils" />
<p>This is an effort to implement a full-featured standalone CSL
processor in Javascript, for use by the Zotero project, and by other
sites and platforms that can benefit from a standard method of
formatting citation data.</p>
<div class="section" id="the-architecture">
<h1>The Architecture</h1>
<p>The following link has (dated but to be maintained) JsDoc documentation
that will eventually provide some guidance re how things fit together:</p>
<blockquote>
<a class="reference external" href="http://gsl-nagoya-u.net/http/pub/citeproc-js-doc/index.html">http://gsl-nagoya-u.net/http/pub/citeproc-js-doc/index.html</a></blockquote>
<p>In rough outline, there is a two-stage compiler (Build and Configure)
that can be used to construct an object with a few methods useful for
loading CSL styles and rendering citations and bibliographies.</p>
<p>The object has several sub-objects, the most important of which are
&quot;registry&quot;, &quot;citation&quot;, &quot;bibliography&quot;, &quot;citation_sort&quot; and
&quot;bibliography_sort&quot;.  The top-level methods on the main object apply
execution wrappers to token lists contained in &quot;citation&quot; and
&quot;bibliography&quot;, to produce string or list-of-string output.  The
&quot;registry&quot; object provides a persistent store for managing
bibliography sort order and disambiguation.  The output queue in this
scenario is built as a nested hierarchy which is then collapsed into a
formatted string for output.</p>
</div>
<div class="section" id="testing-testing">
<h1>Testing, testing ...</h1>
<p>As you can see from the sources, tests are kind of important here.
Javascript is notoriously unfriendly when it comes to debugging, the
processor is charged with an extremely complex formatting task, and
the target community (us) is unforgiving.  Things have to work
correctly, and the only way to assure that they do is to test the code
thoroughly.</p>
<p>Test suites are useful to us in all sorts of ways.  Standard tests
(housed under ./std) help to assure that the various CSL
implementations produce identical results.  The internal tests
specific to citeproc-js provide insurance against unexpected
side-effects in the event of wholesale refactoring (of which there has
been more than I would like to remember).  Tests are not just about
QA; they help to keep complexity from running out of control, by
forcing the programmer (me) to confront it regularly when changes are
made to the codebase.  The suites are an integral part of the
development process; if you modify or add code to the processor (and
contributions are welcome!), be sure to complement your changes with
tests.  It's the right thing to do.</p>
</div>
<div class="section" id="archive-layout">
<h1>Archive Layout</h1>
<p>The sources of the program are under ./src.  The ./locale and ./style
directories contain standard files from the CSL distribution, for
use in testing.  The tests are located under ./tests (for those
specific to citeproc-js) and ./std (for the standard CSL test
fixtures).</p>
<p>The basic testing framework we use is DOH, from the Dojo project.
If your machine has Java installed, the ./dojo and ./rhino directories
provide the remaining infrastructure needed to run the tests via the
./runtests.sh or ./runtests.bat scripts.</p>
<p>The ./data directory contains input files for running tests.  Over
time, this material will be moved into the standard test suite
area, and this directory will eventually go away.  The ./ref directory
contains a grab-bag of documents and files stashed or shoved aside
during development.</p>
</div>
<div class="section" id="standard-tests-and-test-scripts">
<h1>Standard tests and test scripts</h1>
<p>Standard tests are shipped in two subdirectories, <tt class="docutils literal"><span class="pre">./std/humans</span></tt> and
<tt class="docutils literal"><span class="pre">./std/machines</span></tt>.  New tests and editorial changes should be made in the
<tt class="docutils literal"><span class="pre">./std/humans</span></tt> directory, populating the changes to the <tt class="docutils literal"><span class="pre">./std/machines</span></tt>
directory using the <tt class="docutils literal"><span class="pre">./std/grind.py</span></tt> Python script (<tt class="docutils literal"><span class="pre">grind.py</span></tt> can also be
used for validation -- run it with the <tt class="docutils literal"><span class="pre">--help</span></tt> option for more info).
The actual test runners use the machine-readable form of the tests.</p>
<div class="section" id="running-in-rhino-runtests-sh">
<h2>Running in <tt class="docutils literal"><span class="pre">rhino</span></tt>: <tt class="docutils literal"><span class="pre">runtests.sh</span></tt></h2>
<p>The primary script that runs all the tests is <tt class="docutils literal"><span class="pre">./run-rhino.sh</span></tt>, in the
top-level directory.  Rintze Zelle has very kindly provided a
<tt class="docutils literal"><span class="pre">./run-rhino.bat</span></tt> file as well, and the tests reportedly run (and we
hope also break) equally well on Windows boxes.</p>
<p>If you have a Java interpreter installed and are on Linux (or possibly
a Mac), you can run the tests in a checkout from a terminal by
entering the top directory and just typing the runtests script
appropriate for your system.</p>
<p>On Windows, the <tt class="docutils literal"><span class="pre">./run-rhino.bat</span></tt> file can be run from the command prompt,
the only caveat being that the command prompt should be set to the drive
harboring the SVN working copy, e.g.
<tt class="docutils literal"><span class="pre">D:\&gt;D:\xbiblio\citeproc-js\trunk\runtests.bat</span></tt> works whereas
<tt class="docutils literal"><span class="pre">C:\&gt;D:\xbiblio\citeproc-js\trunk\runtests.bat</span></tt>
gives an error when executed.</p>
</div>
<div class="section" id="running-in-spidermonkey-test-py">
<h2>Running in <tt class="docutils literal"><span class="pre">spidermonkey</span></tt>: <tt class="docutils literal"><span class="pre">test.py</span></tt></h2>
<p>The <tt class="docutils literal"><span class="pre">./run-spidermonkey.py</span></tt> script runs the tests using a standalone Spidermonkey
interpreter similar to that used in Firefox. The  kit used for this purpose
is the <tt class="docutils literal"><span class="pre">python-spidermonkey</span></tt> bridge done by Paul Davis, which is available,
with install instructions, here:</p>
<blockquote>
<a class="reference external" href="http://github.com/davisp/python-spidermonkey/tree/master">http://github.com/davisp/python-spidermonkey/tree/master</a></blockquote>
</div>
<div class="section" id="running-in-tracemonkey-runtracem-sh">
<h2>Running in <tt class="docutils literal"><span class="pre">tracemonkey</span></tt>: <tt class="docutils literal"><span class="pre">runtracem.sh</span></tt></h2>
<p>The <tt class="docutils literal"><span class="pre">tracemonkey</span></tt> Javascript engine is significantly faster than either
<tt class="docutils literal"><span class="pre">spidermonkey</span></tt> or <tt class="docutils literal"><span class="pre">rhino</span></tt>, and is used by the <tt class="docutils literal"><span class="pre">run-tracemonkey.sh</span></tt>
script.  To run it you will need to do the following on a Linux system:</p>
<ol class="arabic simple">
<li>Download the sources of <a class="reference external" href="http://code.google.com/p/jslibs/source/checkout">the jslibs development environment</a>.</li>
<li>Compile the sources with <tt class="docutils literal"><span class="pre">make</span> <span class="pre">all;</span> <span class="pre">make</span> <span class="pre">copy</span></tt> (under Linux)
or by whatever means is appropriate to your operating system.</li>
<li>Enter the directory <tt class="docutils literal"><span class="pre">./libs/js/src</span></tt> in the <tt class="docutils literal"><span class="pre">jslibs</span></tt> source
archive, and compile the js interpreter as well.  This will generate
the <tt class="docutils literal"><span class="pre">libmozjs.so</span></tt> shared library.</li>
<li>Make a note of the path to the <tt class="docutils literal"><span class="pre">jshost</span></tt> binary, and of the path
to the <tt class="docutils literal"><span class="pre">libmozjs.so</span></tt> library.</li>
<li>Register <tt class="docutils literal"><span class="pre">libmozjs.so</span></tt> in the operating system's dynamic linker.
This is normally done by placing a file containing the relevant path
(less the actual name of the library) under <tt class="docutils literal"><span class="pre">/etc/ld.so.conf.d/</span></tt>,
in a file with a <tt class="docutils literal"><span class="pre">.conf</span></tt> extension.</li>
<li>Run the command <tt class="docutils literal"><span class="pre">ldconfig</span></tt> to complete registration of the library
path.</li>
<li>Return to the <tt class="docutils literal"><span class="pre">citeproc-js</span></tt> archive, and edit the paths as necessary in the file
<tt class="docutils literal"><span class="pre">./tests/runner_tracemonkey.js</span></tt>.</li>
<li>Try running the <tt class="docutils literal"><span class="pre">./run-tracemonkey.sh</span></tt> script and see if it works.</li>
</ol>
</div>
</div>
<div class="section" id="other-info">
<h1>Other Info</h1>
<p>Information on writing tests using the DOH framework can be found here:</p>
<blockquote>
<a class="reference external" href="http://www.ibm.com/developerworks/web/library/wa-aj-doh/index.html">http://www.ibm.com/developerworks/web/library/wa-aj-doh/index.html</a></blockquote>
<p>The DOH testing framework is part of the Dojo project.  The dojo
framework files under <tt class="docutils literal"><span class="pre">./dojo</span></tt> are from a release instance of the
product compiled from the original source.  (Compiling from scratch
was necessary in order to run DOH from the command line as we do
here.) If you want to use DOH for your own projects, the sources for
Dojo are available here:</p>
<blockquote>
<a class="reference external" href="http://download.dojotoolkit.org/">http://download.dojotoolkit.org/</a></blockquote>
<p>Note that various small changes have been made to the DOH code that
ships with <tt class="docutils literal"><span class="pre">citeproc-js</span></tt>, including the deletion of one line of the code
in order to avoid a timeout issue on my very small and rather slow
laptop.</p>
<p>Enjoy!</p>
</div>
</div>
</body>
</html>
